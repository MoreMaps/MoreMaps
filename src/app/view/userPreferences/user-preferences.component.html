<dev-theme-toggle></dev-theme-toggle>
<profile-button></profile-button>
<app-navbar></app-navbar>

<div class="page-background">

    <div class="preference-card">

        <div class="card-header">
            <h2>Preferencias</h2>
            <p>Personaliza tu experiencia</p>
        </div>

        <form [formGroup]="prefForm" class="vertical-form">

            <div class="form-group">
                <label>Tipo de ruta predeterminado</label>
                <mat-form-field appearance="outline" class="w-full custom-field">
                    <mat-select formControlName="tipoRuta" placeholder="Seleccionar ruta">
                        @for (opt of routesOptions; track opt.value) {
                            <mat-option [value]="opt.value">{{ opt.label }}</mat-option>
                        }
                    </mat-select>

                    @if (prefForm.get('tipoRuta')?.value) {
                        <button mat-icon-button matSuffix
                                (click)="$event.stopPropagation(); prefForm.get('tipoRuta')?.setValue(null)">
                            <mat-icon>cancel</mat-icon>
                        </button>
                    }
                </mat-form-field>
            </div>

            <div class="form-group">
                <label>Transporte predeterminado</label>
                <mat-form-field appearance="outline" class="w-full custom-field">
                    <mat-select formControlName="tipoTransporte" placeholder="Seleccionar transporte">
                        @for (opt of transportOptions; track opt.value) {
                            <mat-option [value]="opt.value">{{ opt.label }}</mat-option>
                        }
                    </mat-select>

                    @if (prefForm.get('tipoTransporte')?.value) {
                        <button mat-icon-button matSuffix
                                (click)="$event.stopPropagation(); prefForm.get('tipoTransporte')?.setValue(null)">
                            <mat-icon>cancel</mat-icon>
                        </button>
                    }
                </mat-form-field>
            </div>

            @if (isVehicleSelected) {
                <div class="form-group">
                    <label>Vehículo predeterminado</label>

                    <mat-form-field appearance="outline"
                                    class="w-full custom-field cursor-pointer"
                                    [class.mat-form-field-invalid]="prefForm.get('matricula')?.invalid && prefForm.get('matricula')?.touched"
                                    (click)="openVehicleSelector()">

                        <input [value]="selectedVehicleAlias()"
                               matInput
                               placeholder="Toca para seleccionar"
                               readonly
                               style="cursor: pointer;">

                        <mat-icon matPrefix>directions_car</mat-icon>

                        @if (!prefForm.get('matricula')?.value) {
                            <mat-icon matSuffix>expand_more</mat-icon>
                        }

                        @if (prefForm.get('matricula')?.value) {
                            <button (click)="clearVehicleSelection($event)" mat-icon-button matSuffix>
                                <mat-icon>cancel</mat-icon>
                            </button>
                        }
                    </mat-form-field>

                    @if (prefForm.get('matricula')?.hasError('required') && prefForm.get('matricula')?.touched) {
                        <mat-error class="text-xs mt-1">Debes seleccionar un vehículo</mat-error>
                    }
                </div>
            }

            <div class="info-group">
                <label class="block mb-3" style="font-size: 0.85rem; opacity: 0.8;">Información a mostrar</label>

                <div class="checkbox-list">
                    <mat-checkbox color="primary" formControlName="checkTodo">
                        Todo
                    </mat-checkbox>

                    <div style="padding-left: 1rem; display: flex; flex-direction: column; gap: 0.5rem;">
                        <mat-checkbox color="primary" formControlName="costeCombustible">
                            Coste del combustible
                        </mat-checkbox>
                        <mat-checkbox color="primary" formControlName="costeCalorias">
                            kCal (ruta a pie o en bici)
                        </mat-checkbox>
                    </div>
                </div>
            </div>

            <button (click)="onSubmit()"
                    [disabled]="loading || prefForm.invalid || !hasChanges"
                    class="btn-custom btn-save"
                    type="button">
                @if (loading) {
                    <span>Guardando...</span>
                } @else {
                    <span>GUARDAR CAMBIOS</span>
                }
            </button>

            <div class="divider"></div>

            <div class="actions-container">
                <button class="btn-custom btn-delete" type="button">
                    <mat-icon>delete</mat-icon>
                    BORRAR CUENTA
                </button>
            </div>

        </form>
    </div>
</div>
