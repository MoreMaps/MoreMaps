<dev-theme-toggle></dev-theme-toggle>
<app-navbar></app-navbar>

<div class="saved-items-container">
    <profile-button></profile-button>

    <div class="items-list-section">
        <div class="section-header">
            <h2 class="section-title">Elementos guardados</h2>

            <div class="item-type-selector">
                <button class="type-button" [class.active]="selectedType() === 'lugares'" (click)="selectType('lugares')">
                    Lugares
                </button>
                <button class="type-button" [class.active]="selectedType() === 'vehiculos'" (click)="selectType('vehiculos')">
                    Vehículos
                </button>
                <button class="type-button" [class.active]="selectedType() === 'rutas'" (click)="selectType('rutas')">
                    Rutas
                </button>
            </div>

            @if (items().length > 0) {
                <div class="pagination">
                    <span class="page-info">Página {{ currentPage() }} de {{ totalPages() }}</span>
                    <div class="pagination-buttons">
                        <button mat-icon-button (click)="previousPage()" [disabled]="currentPage() === 1">
                            <mat-icon>chevron_left</mat-icon>
                        </button>
                        <button mat-icon-button (click)="nextPage()" [disabled]="currentPage() === totalPages()">
                            <mat-icon>chevron_right</mat-icon>
                        </button>
                    </div>
                </div>
            }
        </div>

        @if (items().length > 0) {

            <div class="items-list">
                @switch (selectedType()) {

                    @case ('lugares') {
                        @for (itemData of paginatedItemsWithNames(); track itemData.item.geohash) {
                            <div class="item-card"
                                 (click)="selectItem(itemData.item)"
                                 [class.selected]="selectedItem?.geohash === itemData.item.geohash">
                                <div class="item-icon">
                                    <img ngSrc="../../../assets/images/poi/poi_active.png" height="44" width="33" priority class="poi-icon-img"
                                         [class.visible]="selectedItem?.geohash === itemData.item.geohash" alt="active POI">
                                    <img ngSrc="../../../assets/images/poi/poi_inactive.png" priority height="44" width="33" class="poi-icon-img"
                                         [class.visible]="selectedItem?.geohash !== itemData.item.geohash" alt="inactive POI">
                                </div>
                                <div class="item-info">
                                    <h3 class="item-name">{{ itemData.displayName }}</h3>
                                    @if (itemData.displayName !== itemData.item.placeName) {
                                        <p class="item-place-if-alias">{{ itemData.item.placeName }}</p>
                                    }
                                    <p class="item-description">({{ itemData.item.lat | number:'1.2-4' }}, {{ itemData.item.lon | number:'1.2-4' }})</p>
                                </div>
                                <button mat-icon-button class="favorite-button" [class.pinned]="itemData.item.pinned" (click)="toggleFavorite(itemData.item, $event)">
                                    <mat-icon>{{ itemData.item.pinned ? 'star' : 'star_border' }}</mat-icon>
                                </button>
                            </div>
                        }
                    }

                    @case ('vehiculos') {
                        @for (itemData of paginatedItemsWithNames(); track itemData.item.matricula) {
                            <div class="item-card"
                                 (click)="selectItem(itemData.item)"
                                 [class.selected]="selectedItem?.matricula === itemData.item.matricula">
                                <div class="item-icon">
                                    <img ngSrc="../../../assets/images/vehicle/vehicle_off.png" height="50" width="50" priority class="poi-icon-img"
                                         [class.visible]="selectedItem?.matricula === itemData.item.matricula" alt="active vehicle">
                                    <img ngSrc="../../../assets/images/vehicle/vehicle_on.png" priority height="50" width="50" class="poi-icon-img"
                                         [class.visible]="selectedItem?.matricula !== itemData.item.matricula" alt="inactive vehicle">
                                </div>
                                <div class="item-info">
                                    <h3 class="item-name">{{ itemData.displayName }}</h3>
                                    <p class="item-description" style="font-weight: 500;">{{ itemData.item.matricula }}</p>
                                    <p class="item-description">{{ itemData.item.marca }} {{ itemData.item.modelo }} {{ itemData.item.anyo }}</p>
                                </div>
                                <button mat-icon-button class="favorite-button" [class.pinned]="itemData.item.pinned" (click)="toggleFavorite(itemData.item, $event)">
                                    <mat-icon>{{ itemData.item.pinned ? 'star' : 'star_border' }}</mat-icon>
                                </button>
                            </div>
                        }
                    }

                    @case ('rutas') {
                        @for (itemData of paginatedItemsWithNames(); track itemData.item.id()) {
                            <div class="item-card"
                                 (click)="selectItem(itemData.item)"
                                 [class.selected]="selectedItem?.id() === itemData.item.id()">

                                <div class="item-icon">
                                    <img ngSrc="assets/images/route/route_on.svg" height="58" width="52" priority class="poi-icon-img"
                                         [class.visible]="selectedItem?.id() === itemData.item.id()" alt="active route">
                                    <img ngSrc="assets/images/route/route_off.svg" priority height="58" width="52" class="poi-icon-img"
                                         [class.visible]="selectedItem?.id() !== itemData.item.id()" alt="inactive route">
                                </div>

                                <div class="item-info">
                                    <h3 class="item-name">{{ itemData.item.alias }}</h3>

                                    <p class="item-description">{{ Math.trunc(itemData.item.tiempo / 3600) }} h
                                        {{ Math.trunc((itemData.item.tiempo % 3600) / 60) }} min
                                        • {{ Math.trunc(itemData.item.distancia / 1000) }} km</p>

                                    <p class="item-description" style="font-weight: 500;">
                                        {{ getRouteTransportLabel(itemData.item) }}, ruta {{ itemData.item.preferenceLabel() }}
                                    </p>
                                </div>

                                <button mat-icon-button class="favorite-button" [class.pinned]="itemData.item.pinned" (click)="toggleFavorite(itemData.item, $event)">
                                    <mat-icon>{{ itemData.item.pinned ? 'star' : 'star_border' }}</mat-icon>
                                </button>
                            </div>
                        }
                    }
                }
            </div>

        } @else {
            <div class="empty-state">
                <mat-icon class="empty-icon">bookmark_border</mat-icon>
                <p class="empty-message">{{ emptyMessage() }}</p>
            </div>
        }
    </div>

    <div class="details-container">
        @if (!selectedItem) {
            <div class="empty-selection-placeholder">
                <p>Selecciona un elemento para ver sus detalles.</p>
            </div>
        } @else {
            @if (isDesktop()) {
                @switch (selectedType()) {
                    @case ('lugares') {
                        <app-saved-poi-dialog
                            [item]="selectedItem"
                            [displayName]="selectedItemDisplayName()"
                            (actionEvent)="handleDialogActions($event)"
                            (closeEvent)="deselectItem()">
                        </app-saved-poi-dialog>
                    }
                    @case ('vehiculos') {
                        <app-saved-vehicle-dialog
                            [item]="selectedItem"
                            [displayName]="selectedItemDisplayName()"

                            [existingMatriculas]="allMatriculas()"

                            (actionEvent)="handleDialogActions($event)"
                            (closeEvent)="deselectItem()">
                        </app-saved-vehicle-dialog>
                    }
                    @case ('rutas') {
                        <app-saved-route-dialog
                            [item]="selectedItem"
                            [displayName]="selectedItemDisplayName()"
                            [displayTransport]="getRouteTransportLabel(selectedItem)"
                            (actionEvent)="handleDialogActions($event)"
                            (closeEvent)="deselectItem()">
                        </app-saved-route-dialog>
                    }
                }
            }
        }
    </div>
</div>
