<profile-button></profile-button>
<app-navbar></app-navbar>
<dev-theme-toggle></dev-theme-toggle>

<div class="registration-container">

    <header class="header-section">
        <h2 class="page-title">Registrar nuevo vehículo</h2>
    </header>

    <form [formGroup]="vehicleForm" (ngSubmit)="onSubmit()">

        <section class="form-section">
            <h3 class="section-title">Identificar el vehículo</h3>

            <div class="form-grid">
                <div class="form-group item-matricula">
                    <label>Matrícula *</label>
                    <div class="input-wrapper">
                        <input type="text" formControlName="matricula" placeholder="1234 ABC" autocomplete="off"
                               [class.ng-invalid]="vehicleForm.get('matricula')?.invalid && vehicleForm.get('matricula')?.touched">
                        @if (vehicleForm.get('matricula')?.value && !isLoading()) {
                            <button type="button" class="clear-btn" (click)="clearField('matricula')">⊗</button>
                        }
                    </div>
                    @if (vehicleForm.get('matricula')?.touched) {
                        @if (vehicleForm.get('matricula')?.hasError('required')) {
                            <span class="error-msg">Requerido</span>
                        }
                        @else if (vehicleForm.get('matricula')?.hasError('pattern')) {
                            <span class="error-msg">Formato inválido (Ej: 1234BCD)</span>
                        }
                        @else if (vehicleForm.get('matricula')?.hasError('hasVowels')) {
                            <span class="error-msg">No se permiten vocales</span>
                        }
                        @else if (vehicleForm.get('matricula')?.hasError('alreadyExists')) {
                            <span class="error-msg">Matrícula ya registrada</span>
                        }
                    }
                </div>

                <div class="form-group">
                    <label>Alias *</label>
                    <div class="input-wrapper">
                        <input type="text" formControlName="alias" placeholder="Mi coche rojo">
                        @if (vehicleForm.get('alias')?.value && !isLoading()) {
                            <button type="button" class="clear-btn" (click)="clearField('alias')">⊗</button>
                        }
                    </div>
                    @if (vehicleForm.get('alias')?.hasError('required')) {
                        <span class="error-msg">Requerido</span>
                    }
                    @else if (vehicleForm.get('alias')?.hasError('maxlength')) {
                        <span class="error-msg">
                        Máximo 50 caracteres (actual: {{ vehicleForm.get('alias')?.errors?.['maxlength']?.actualLength }})
                        </span>
                    }
                </div>

                <div class="form-group">
                    <label>Marca *</label>
                    <div class="input-wrapper">
                        <input type="text" formControlName="marca" placeholder="Toyota">
                        @if (vehicleForm.get('marca')?.value && !isLoading()) {
                            <button type="button" class="clear-btn" (click)="clearField('marca')">⊗</button>
                        }
                    </div>
                    @if (vehicleForm.get('marca')?.hasError('required') && vehicleForm.get('marca')?.touched) {
                        <span class="error-msg">Requerido</span>
                    }
                </div>

                <div class="form-group">
                    <label>Modelo *</label>
                    <div class="input-wrapper">
                        <input type="text" formControlName="modelo" placeholder="Corolla">
                        @if (vehicleForm.get('modelo')?.value && !isLoading()) {
                            <button type="button" class="clear-btn" (click)="clearField('modelo')">⊗</button>
                        }
                    </div>
                    @if (vehicleForm.get('modelo')?.hasError('required') && vehicleForm.get('modelo')?.touched) {
                        <span class="error-msg">Requerido</span>
                    }
                </div>

                <div class="form-group">
                    <label>Año *</label>
                    <div class="input-wrapper">
                        <input type="number" formControlName="anyo" [max]="currentYear + 1" min="1900">
                        @if (vehicleForm.get('anyo')?.value && !isLoading()) {
                            <button type="button" class="clear-btn" (click)="clearField('anyo')">⊗</button>
                        }
                    </div>
                    @if (vehicleForm.get('anyo')?.touched) {
                        @if (vehicleForm.get('anyo')?.hasError('required')) {
                            <span class="error-msg">Requerido</span>
                        } @else if (vehicleForm.get('anyo')?.hasError('min') || vehicleForm.get('anyo')?.hasError('max')) {
                            <span class="error-msg">Año inválido</span>
                        }
                    }
                </div>
            </div>
        </section>

        <section class="form-section">
            <h3 class="section-title">Datos de combustible</h3>
            <p class="section-subtitle">
                Con estos datos calculamos el coste de una ruta.
            </p>

            <div class="form-grid fuel-grid">
                <div class="form-group">
                    <label>Tipo de combustible *</label>
                    <select formControlName="tipoCombustible" class="form-select">
                        <option value="" disabled selected>Selecciona una opción</option>
                        @for (fuel of Object.values(FUEL_TYPE); track fuel) {
                            <option [value]="fuel">{{ fuel }}</option>
                        }
                    </select>
                    @if (vehicleForm.get('tipoCombustible')?.hasError('required') && vehicleForm.get('tipoCombustible')?.touched) {
                        <span class="error-msg">Requerido</span>
                    }
                </div>

                <div class="form-group">
                    <label>
                        Consumo medio *
                        @if(consumptionUnit()) {
                            <span style="font-weight: 400; font-size: 0.85em; opacity: 0.8">({{ consumptionUnit() }})</span>
                        }
                    </label>
                    <div class="input-wrapper">
                        <input type="number" formControlName="consumoMedio" placeholder="0.0" step="0.1" min="0.1">
                        @if (vehicleForm.get('consumoMedio')?.value && !isLoading()) {
                            <button type="button" class="clear-btn" (click)="clearField('consumoMedio')">⊗</button>
                        }
                    </div>
                    @if (vehicleForm.get('consumoMedio')?.touched) {
                        @if (vehicleForm.get('consumoMedio')?.hasError('required')) {
                            <span class="error-msg">Requerido</span>
                        } @else if (vehicleForm.get('consumoMedio')?.hasError('min')) {
                            <span class="error-msg">Mínimo 0.1</span>
                        }
                    }
                </div>
            </div>
        </section>

        <div class="actions-container">
            <button type="submit" class="save-button" [disabled]="vehicleForm.invalid || isLoading()">
                @if (isLoading()) {
                    <mat-spinner diameter="20" color="accent"></mat-spinner>
                } @else {
                    GUARDAR
                }
            </button>
        </div>

    </form>
</div>
