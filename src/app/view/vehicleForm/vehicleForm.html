<profile-button></profile-button>
<app-navbar></app-navbar>
<dev-theme-toggle></dev-theme-toggle>

<div class="registration-container">

    <header class="header-section">
        <h2 class="page-title">Registrar nuevo vehículo</h2>
    </header>

    <form (ngSubmit)="onSubmit()" [formGroup]="vehicleForm">

        <section class="form-section">
            <h3 class="section-title">Identificar el vehículo</h3>

            <div class="form-grid">

                <div class="form-group item-matricula">
                    <label>Matrícula *</label>
                    <mat-form-field appearance="outline" class="w-full custom-field">
                        <input matInput formControlName="matricula" placeholder="1234BCD" autocomplete="off">

                        @if (vehicleForm.get('matricula')?.value && !isLoading()) {
                            <button mat-icon-button matSuffix type="button" (click)="clearField('matricula')">
                                <mat-icon>cancel</mat-icon>
                            </button>
                        }

                        @if (vehicleForm.get('matricula')?.hasError('required')) {
                            <mat-error>Requerido</mat-error>
                        } @else if (vehicleForm.get('matricula')?.hasError('pattern')) {
                            <mat-error>Formato inválido (Ej: 1234BCD)</mat-error>
                        } @else if (vehicleForm.get('matricula')?.hasError('hasVowels')) {
                            <mat-error>No se permiten vocales</mat-error>
                        } @else if (vehicleForm.get('matricula')?.hasError('alreadyExists')) {
                            <mat-error>Matrícula ya registrada</mat-error>
                        }
                    </mat-form-field>
                </div>

                <div class="form-group">
                    <label>Alias *</label>
                    <mat-form-field appearance="outline" class="w-full custom-field">
                        <input matInput formControlName="alias" placeholder="Mi coche rojo">

                        @if (vehicleForm.get('alias')?.value && !isLoading()) {
                            <button mat-icon-button matSuffix type="button" (click)="clearField('alias')">
                                <mat-icon>cancel</mat-icon>
                            </button>
                        }

                        @if (vehicleForm.get('alias')?.hasError('required')) {
                            <mat-error>Requerido</mat-error>
                        } @else if (vehicleForm.get('alias')?.hasError('maxlength')) {
                            <mat-error>Máximo 50 caracteres</mat-error>
                        } @else if (vehicleForm.get('alias')?.hasError('onlyWhitespace')) {
                            <mat-error>El campo no puede estar vacío</mat-error>
                        }
                    </mat-form-field>
                </div>

                <div class="form-group">
                    <label>Marca *</label>
                    <mat-form-field appearance="outline" class="w-full custom-field">
                        <input matInput formControlName="marca" placeholder="Toyota">

                        @if (vehicleForm.get('marca')?.value && !isLoading()) {
                            <button mat-icon-button matSuffix type="button" (click)="clearField('marca')">
                                <mat-icon>cancel</mat-icon>
                            </button>
                        }

                        @if (vehicleForm.get('marca')?.hasError('required')) {
                            <mat-error>Requerido</mat-error>
                        } @else if (vehicleForm.get('marca')?.hasError('hasVowels')) {
                            <mat-error>Campo inválido</mat-error>
                        }
                    </mat-form-field>
                </div>

                <div class="form-group">
                    <label>Modelo *</label>
                    <mat-form-field appearance="outline" class="w-full custom-field">
                        <input matInput formControlName="modelo" placeholder="Corolla">

                        @if (vehicleForm.get('modelo')?.value && !isLoading()) {
                            <button mat-icon-button matSuffix type="button" (click)="clearField('modelo')">
                                <mat-icon>cancel</mat-icon>
                            </button>
                        }

                        @if (vehicleForm.get('modelo')?.hasError('required')) {
                            <mat-error>Requerido</mat-error>
                        } @else if (vehicleForm.get('modelo')?.hasError('onlyWhitespace')) {
                            <mat-error>Campo inválido</mat-error>
                        }
                    </mat-form-field>
                </div>

                <div class="form-group">
                    <label>Año *</label>
                    <mat-form-field appearance="outline" class="w-full custom-field">
                        <input matInput type="number" formControlName="anyo" min="1900" [max]="currentYear + 1">

                        @if (vehicleForm.get('anyo')?.value && !isLoading()) {
                            <button mat-icon-button matSuffix type="button" (click)="clearField('anyo')">
                                <mat-icon>cancel</mat-icon>
                            </button>
                        }

                        @if (vehicleForm.get('anyo')?.hasError('required')) {
                            <mat-error>Requerido</mat-error>
                        } @else if (vehicleForm.get('anyo')?.hasError('min') || vehicleForm.get('anyo')?.hasError('max')) {
                            <mat-error>Año inválido</mat-error>
                        }
                    </mat-form-field>
                </div>
            </div>
        </section>

        <section class="form-section">
            <h3 class="section-title">Datos de combustible</h3>
            <p class="section-subtitle">
                Con estos datos calculamos el coste de una ruta.
            </p>

            <div class="form-grid fuel-grid">
                <div class="form-group">
                    <label>Tipo de combustible *</label>
                    <mat-form-field appearance="outline" class="w-full custom-field">
                        <mat-select formControlName="tipoCombustible" placeholder="Selecciona una opción">
                            @for (fuel of Object.values(FUEL_TYPE); track fuel) {
                                <mat-option [value]="fuel">{{ fuel }}</mat-option>
                            }
                        </mat-select>

                        @if (vehicleForm.get('tipoCombustible')?.value) {
                            <button mat-icon-button matSuffix type="button"
                                    (click)="$event.stopPropagation(); vehicleForm.get('tipoCombustible')?.setValue(null)">
                                <mat-icon>cancel</mat-icon>
                            </button>
                        }

                        @if (vehicleForm.get('tipoCombustible')?.hasError('required')) {
                            <mat-error>Requerido</mat-error>
                        }
                    </mat-form-field>
                </div>

                <div class="form-group">
                    <label>
                        Consumo medio *
                        @if (consumptionUnit()) {
                            <span style="font-weight: 400; font-size: 0.85em; opacity: 0.8">({{ consumptionUnit() }})</span>
                        }
                    </label>
                    <mat-form-field appearance="outline" class="w-full custom-field">
                        <input matInput type="number" formControlName="consumoMedio" placeholder="0.0" step="0.1" min="0.1">

                        @if (vehicleForm.get('consumoMedio')?.value && !isLoading()) {
                            <button mat-icon-button matSuffix type="button" (click)="clearField('consumoMedio')">
                                <mat-icon>cancel</mat-icon>
                            </button>
                        }

                        @if (vehicleForm.get('consumoMedio')?.hasError('required')) {
                            <mat-error>Requerido</mat-error>
                        } @else if (vehicleForm.get('consumoMedio')?.hasError('min')) {
                            <mat-error>Mínimo 0.1</mat-error>
                        }
                    </mat-form-field>
                </div>
            </div>
        </section>

        <div class="actions-container">
            <button class="save-button" type="submit" [disabled]="vehicleForm.invalid || isLoading()">
                @if (isLoading()) {
                    <mat-spinner diameter="20" color="accent"></mat-spinner>
                } @else {
                    GUARDAR
                }
            </button>
        </div>

    </form>
</div>
