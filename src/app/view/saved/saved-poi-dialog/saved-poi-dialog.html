<div class="dialog-container">
    <div class="dialog-header">
        <div class="header-content">
            <div class="poi-icon-wrapper">
                <img ngSrc="assets/images/poi_active.png" height="44" width="33" priority alt="POI" class="poi-img">
            </div>

            <div class="header-text">
                @if (!isEditing()) {
                    <h2 class="dialog-title">{{ displayData.displayName }}</h2>
                    @if (displayData.displayName !== displayData.item.placeName) {
                        <p class="dialog-subtitle">{{ displayData.item.placeName }}</p>
                    }
                    <p class="dialog-coords">
                        ({{ displayData.item.lat || '0.00' | number:'1.2-4' }}, {{ displayData.item.lon || '0.00' | number:'1.2-4' }})
                    </p>
                } @else {
                    <h2 class="dialog-title"> Editar POI</h2>
                    <p class="dialog-subtitle">Modifica los detalles</p>
                }
            </div>
        </div>

        <button mat-icon-button (click)="close()" class="close-btn">
            <mat-icon>close</mat-icon>
        </button>
    </div>

    <div class="dialog-body">
        <div class="actions-list">
            @if (!isEditing()) {
                @if(displayData.item.description && displayData.item.description!.trim() !== ''){
                    <p class="description">
                        {{ displayData.item.description }}
                    </p>
                } @else {
                    <p class="description" style="opacity: 0.6;">
                        No hay descripción...
                    </p>
                }

                <div class="actions-list">
                    <button class="action-item" (click)="onNewRoute()">
                        <div class="icon-circle green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="action-svg">
                                <path d="M5 12h14m-7-7l7 7-7 7"/>
                            </svg>
                        </div>
                        <span class="action-label green-text">NUEVA RUTA</span>
                    </button>

                    <button class="action-item" (click)="onShowOnMap()">
                        <div class="icon-circle green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="action-svg">
                                <path d="M9 20l-5.447-2.724A1 1 0 0 1 3 16.382V5.618a1 1 0 0 1 1.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0 0 21 18.382V7.618a1 1 0 0 0-1.447-.894L15 4m0 13V4"/>
                            </svg>
                        </div>
                        <span class="action-label green-text">VER EN EL MAPA</span>
                    </button>

                    <button class="action-item" (click)="onEdit()">
                        <div class="icon-circle green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="action-svg">
                                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                            </svg>
                        </div>
                        <span class="action-label green-text">EDITAR</span>
                    </button>

                    <button class="action-item" (click)="onDelete()">
                        <svg viewBox="0 0 24 24" fill="currentColor" class="action-svg trash-svg">
                            <path d="M19 6h-2c0-1.657-1.343-3-3-3h-4c-1.657 0-3 1.343-3 3H5c-1.103 0-2 .897-2 2v2h18V8c0-1.103-.897-2-2-2zM5 11v9a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-9H5zm4 3h1.5v3H9v-3zm4.5 0H15v3h-1.5v-3z"/>
                        </svg>
                        <span class="action-label orange-text">ELIMINAR</span>
                    </button>
                </div>
            }

            @else {
                <form [formGroup]="editForm" class="edit-form">
                    <div class="form-group">
                        <label>Alias</label>
                        <div class="input-wrapper">
                            <input type="text" formControlName="alias" placeholder="Ej. Casa de Juan"/>
                            @if (editForm.get('alias')?.value) {
                                <button type="button" class="clear-input-btn" (click)="clearField('alias')">
                                    <mat-icon>cancel</mat-icon>
                                </button>
                            }
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Descripción</label>
                        <div class="input-wrapper">
                            <textarea formControlName="description" placeholder="Añade una nota..." rows="4"></textarea>
                            @if (editForm.get('description')?.value) {
                                <button type="button" class="clear-input-btn textarea-clear" (click)="clearField('description')">
                                    <mat-icon>cancel</mat-icon>
                                </button>
                            }
                        </div>
                        <div class="char-count-wrapper">
                            <small class="char-count">{{ descriptionLength }}/150</small>
                        </div>
                    </div>

                    <div class="edit-actions">
                        <button class="btn-save" (click)="onSaveEdit()" [disabled]="!editForm.valid">
                            GUARDAR
                        </button>
                        <button class="btn-cancel" (click)="onCancelEdit()">
                            CANCELAR
                        </button>
                    </div>
                </form>
            }
        </div>
    </div>

    @if (isDeleting()) {
        <app-delete-confirmation-popup
        [geohash]="displayData.item.geohash"
        [poiName]="displayData.displayName"
        [auth]="auth"
        (close)="onCancelDelete()"
        (success)="onDeleteSuccess($event)">
        </app-delete-confirmation-popup>
    }

</div>
